<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üß© ÿ≥ŸàÿØŸàŸÉŸà - {{ difficulty }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 10px;
            color: #fff;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .header h2 { font-size: clamp(1.2rem, 4vw, 1.5rem); margin-bottom: 10px; color: #3498db; }
        .info-bar { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: clamp(0.85rem, 3vw, 1rem);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .timer {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            animation: pulse 1s infinite;
        }
        .timer.warning { background: rgba(241, 196, 15, 0.3); border-color: #f1c40f; animation: pulse 0.5s infinite; }
        .timer.danger { background: rgba(231, 76, 60, 0.6); border-color: #c0392b; animation: pulse 0.3s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .game-board {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; margin: 0 auto; min-width: 300px; }
        td {
            width: 11.11%;
            height: clamp(35px, 10vw, 45px);
            border: 1px solid #bdc3c7;
            text-align: center;
            position: relative;
        }
        tr:nth-child(3n) td { border-bottom: 3px solid #2c3e50; }
        td:nth-child(3n) { border-left: 3px solid #2c3e50; border-right: 3px solid #2c3e50; }
        tr:first-child td { border-top: 3px solid #2c3e50; }
        tr:last-child td { border-bottom: 3px solid #2c3e50; }
        td:first-child { border-left: 3px solid #2c3e50; }
        td:last-child { border-right: 3px solid #2c3e50; }
        
        .fixed {
            background: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            font-size: clamp(1.1rem, 5vw, 1.4rem);
        }
        td input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: clamp(1.1rem, 5vw, 1.4rem);
            font-weight: bold;
            color: #2980b9;
            background: transparent;
            outline: none;
            -moz-appearance: textfield;
        }
        td input::-webkit-outer-spin-button,
        td input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        td input:focus { background: rgba(52, 152, 219, 0.1); border-radius: 5px; }
        
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: clamp(0.9rem, 3vw, 1rem);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn:active { transform: scale(0.95); }
        .btn-hint { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .btn-hint:hover { background: linear-gradient(135deg, #e67e22, #d35400); transform: translateY(-2px); }
        .btn-submit { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-submit:hover { background: linear-gradient(135deg, #2ecc71, #27ae60); transform: translateY(-2px); }
        .btn-new { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .btn-new:hover { background: linear-gradient(135deg, #8e44ad, #9b59b6); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        
        .message {
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
            font-size: clamp(0.9rem, 3vw, 1rem);
            display: none;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .message.success { background: rgba(46, 204, 113, 0.2); border: 2px solid #27ae60; color: #2ecc71; }
        .message.error { background: rgba(231, 76, 60, 0.2); border: 2px solid #c0392b; color: #e74c3c; }
        .message.info { background: rgba(52, 152, 219, 0.2); border: 2px solid #2980b9; color: #3498db; }
        
        @media (max-width: 480px) {
            body { padding: 5px; }
            .header { padding: 10px; }
            .game-board { padding: 5px; }
            .btn { padding: 12px 15px; min-width: 100px; }
            .info-item { padding: 6px 10px; font-size: 0.85rem; }
        }
        @media (max-width: 360px) {
            td { height: 32px; }
            .fixed, td input { font-size: 1rem; }
            .btn { padding: 10px 12px; font-size: 0.85rem; }
        }
        @media (min-width: 600px) {
            .game-board { padding: 20px; }
            td { height: 50px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üß© ÿ≥ŸàÿØŸàŸÉŸà - {{ difficulty }}</h2>
            <div class="info-bar">
                <div class="info-item"><span>üí∞</span><span id="points">{{ user_points }}</span></div>
                <div class="info-item timer" id="timer"><span>‚è±Ô∏è</span><span id="time-display">00:00</span></div>
            </div>
        </div>

        <div class="game-board">
            <table id="sudokuTable"></table>
        </div>

        <div class="controls">
            <div class="btn-row">
                <button class="btn btn-hint" id="hintBtn" onclick="getHint()">
                    <span>üí°</span><span>ÿ™ŸÑŸÖŸäÿ≠ (-{{ hint_cost }})</span>
                </button>
                <button class="btn btn-submit" id="submitBtn" onclick="checkSolution()">
                    <span>‚úîÔ∏è</span><span>ÿ™ÿ≠ŸÇŸÇ</span>
                </button>
            </div>
            <div class="btn-row">
                <button class="btn btn-new" id="newGameBtn" onclick="newGame()">
                    <span>üîÑ</span><span>ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ© (-100)</span>
                </button>
            </div>
        </div>
        <div id="message" class="message"></div>
    </div>

    <script>
        const puzzle = {{ puzzle_json|safe }};
        const solution = {{ solution_json|safe }};
        const gameId = "{{ game_id }}";
        const tgId = "{{ tg_id }}";
        const difficulty = "{{ difficulty }}";
        let currentPoints = {{ user_points }};
        let timerInterval;
        let timeRemaining;
        let gameLost = false;

        const TIME_LIMITS = {'easy': 480, 'medium': 720, 'hard': 1080, 'expert': 1800};

        function initGame() {
            buildSudokuTable();
            startTimer();
            setupInputValidation();
        }

        function buildSudokuTable() {
            const table = document.getElementById('sudokuTable');
            table.innerHTML = '';
            for(let i = 0; i < 9; i++) {
                const row = table.insertRow();
                for(let j = 0; j < 9; j++) {
                    const cell = row.insertCell();
                    if(puzzle[i][j] !== 0) {
                        cell.className = 'fixed';
                        cell.textContent = puzzle[i][j];
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.min = 1; input.max = 9;
                        input.dataset.row = i; input.dataset.col = j;
                        input.pattern = '[1-9]'; input.inputMode = 'numeric';
                        cell.appendChild(input);
                    }
                }
            }
        }

        function setupInputValidation() {
            document.querySelectorAll('#sudokuTable input').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^1-9]/g, '');
                    if(value.length > 1) value = value.slice(-1);
                    e.target.value = value;
                });
                input.addEventListener('keydown', function(e) {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    let nextInput;
                    if(e.key === 'ArrowRight' && col < 8) nextInput = document.querySelector(`input[data-row="${row}"][data-col="${col + 1}"]`);
                    else if(e.key === 'ArrowLeft' && col > 0) nextInput = document.querySelector(`input[data-row="${row}"][data-col="${col - 1}"]`);
                    else if(e.key === 'ArrowDown' && row < 8) nextInput = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
                    else if(e.key === 'ArrowUp' && row > 0) nextInput = document.querySelector(`input[data-row="${row - 1}"][data-col="${col}"]`);
                    if(nextInput) { e.preventDefault(); nextInput.focus(); }
                });
            });
        }

        function startTimer() {
            timeRemaining = TIME_LIMITS[difficulty] || 600;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if(timeRemaining <= 0) { clearInterval(timerInterval); gameOver(); }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('time-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('timer');
            if(timeRemaining <= 60) timerEl.className = 'info-item timer danger';
            else if(timeRemaining <= 180) timerEl.className = 'info-item timer warning';
            else timerEl.className = 'info-item timer';
        }

        function gameOver() {
            gameLost = true;
            showMessage('‚è∞ ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™! ŸÑŸÇÿØ ÿÆÿ≥ÿ±ÿ™ ÿßŸÑŸÑÿπÿ®ÿ©.', 'error');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            document.querySelectorAll('#sudokuTable input').forEach(input => input.disabled = true);
            fetch('/check_solution', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({board: getCurrentBoard(), game_id: gameId, time_out: true})
            });
        }

        function getCurrentBoard() {
            const board = [];
            for(let i = 0; i < 9; i++) {
                const row = [];
                for(let j = 0; j < 9; j++) {
                    const input = document.querySelector(`input[data-row="${i}"][data-col="${j}"]`);
                    row.push(input ? parseInt(input.value) || 0 : puzzle[i][j]);
                }
                board.push(row);
            }
            return board;
        }

        async function getHint() {
            if(gameLost) return;
            if(currentPoints < {{ hint_cost }}) { showMessage('‚ùå ÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä!', 'error'); return; }
            try {
                const response = await fetch('/get_hint', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({game_id: gameId, tg_id: tgId})
                });
                const result = await response.json();
                if(result.success && result.hint) {
                    const {row, col, value} = result.hint;
                    const input = document.querySelector(`input[data-row="${row}"][data-col="${col}"]`);
                    if(input) {
                        input.value = value;
                        input.style.color = '#f39c12';
                        input.style.background = 'rgba(243, 156, 18, 0.2)';
                        setTimeout(() => { input.style.color = ''; input.style.background = ''; }, 1500);
                    }
                    currentPoints = result.new_points;
                    document.getElementById('points').textContent = currentPoints;
                    showMessage(`üí° ÿ™ŸÖ ŸÉÿ¥ŸÅ ÿßŸÑÿÆŸÑŸäÿ© (${row+1},${col+1}) = ${value}`, 'info');
                } else { showMessage(result.error || '‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆŸÑÿßŸäÿß ŸÅÿßÿ±ÿ∫ÿ©', 'error'); }
            } catch { showMessage('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error'); }
        }

        async function checkSolution() {
            if(gameLost) return;
            clearInterval(timerInterval);
            const board = getCurrentBoard();
            document.getElementById('submitBtn').disabled = true;
            try {
                const response = await fetch('/check_solution', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({board: board, game_id: gameId})
                });
                const result = await response.json();
                if(result.success) {
                    showMessage(`üéâ ${result.message} +${result.reward} ŸÜŸÇÿ∑ÿ©!`, 'success');
                    document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
                    document.querySelectorAll('#sudokuTable input').forEach(inp => inp.disabled = true);
                } else {
                    showMessage(result.message || '‚ùå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ', 'error');
                    startTimer();
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch { showMessage('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ', 'error'); startTimer(); document.getElementById('submitBtn').disabled = false; }
        }

        async function newGame() {
            if(gameLost) { showMessage('‚ùå ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©. ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑÿ®Ÿàÿ™ ŸÑŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error'); return; }
            if(currentPoints < 100) { showMessage('‚ùå ÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä!', 'error'); return; }
            if(!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿÆÿµŸÖ 100 ŸÜŸÇÿ∑ÿ©')) return;
            try {
                const response = await fetch('/new_game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tg_id: tgId, difficulty: difficulty})
                });
                const result = await response.json();
                if(result.success) location.reload();
                else showMessage(result.error || '‚ùå ÿÆÿ∑ÿ£', 'error');
            } catch { showMessage('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error'); }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => { if(msg.textContent === text) msg.style.display = 'none'; }, 5000);
        }

        window.onload = initGame;
    </script>
</body>
</html>