<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø³ÙˆØ¯ÙˆÙƒÙˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h2>ğŸ¯ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø³ÙˆØ¯ÙˆÙƒÙˆ</h2>
            <div class="game-info">
                <div class="difficulty-selector">
                    <label for="difficulty">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                    <select id="difficulty" onchange="changeDifficulty(this.value)">
                        <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>ğŸ¥‰ Ø³Ù‡Ù„</option>
                        <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>ğŸ¥ˆ Ù…ØªÙˆØ³Ø·</option>
                        <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>ğŸ¥‡ ØµØ¹Ø¨</option>
                        <option value="expert" {% if difficulty == 'expert' %}selected{% endif %}>ğŸ‘‘ Ø®Ø¨ÙŠØ±</option>
                    </select>
                </div>
                <div class="game-stats">
                    <span class="points-display">ğŸ’° Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points">{{ user_points }}</span></span>
                    <span class="timer">â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <span id="timer">00:00</span></span>
                    <span class="mistakes">âŒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <span id="mistakes">0/3</span></span>
                </div>
            </div>
        </div>
        
        <div class="sudoku-grid">
            <table id="sudoku-board">
                {% for i in range(9) %}
                <tr>
                    {% for j in range(9) %}
                    <td class="cell {% if puzzle[i][j] != 0 %}fixed{% endif %}">
                        {% if puzzle[i][j] != 0 %}
                            {{ puzzle[i][j] }}
                        {% else %}
                            <input type="text" 
                                   class="cell-input" 
                                   data-row="{{ i }}" 
                                   data-col="{{ j }}"
                                   maxlength="1"
                                   oninput="validateInput(this, {{ i }}, {{ j }})"
                                   onkeypress="return onlyNumbers(event)">
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>
        
        <div class="game-controls">
            <button onclick="clearBoard()" class="control-btn">ğŸ—‘ Ù…Ø³Ø­</button>
            <button onclick="newGame()" class="control-btn">ğŸ² Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button onclick="showHint()" class="control-btn">ğŸ’¡ ØªÙ„Ù…ÙŠØ­ (50 Ù†Ù‚Ø·Ø©)</button>
            <button onclick="checkSolution()" class="control-btn check-btn">âœ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù„</button>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        const gameId = {{ game_id }};
        const userId = {{ user_id }};
        let mistakes = 0;
        const maxMistakes = 3;
        let timerInterval;
        let seconds = 0;
        let gameActive = true;
        let currentDifficulty = '{{ difficulty }}';
        let points = {{ user_points }};
        
        // Ù†Ù‚Ø§Ø· ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
        const levelPoints = {
            'easy': 125,
            'medium': 200,
            'hard': 300,
            'expert': 500
        };
        
        // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)
        const timeLimits = {
            'easy': 600,
            'medium': 900,
            'hard': 1200,
            'expert': 1800
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            startTimer();
        };

        function onlyNumbers(event) {
            // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† 1-9
            var charCode = event.which ? event.which : event.keyCode;
            if (charCode < 49 || charCode > 57) {
                event.preventDefault();
                return false;
            }
            return true;
        }

        function validateInput(input, row, col) {
            if (!gameActive) return;
            
            var value = input.value;
            if (value.length > 0) {
                var num = parseInt(value, 10);
                if (num < 1 || num > 9) {
                    input.value = '';
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„
                if (!isValidMove(row, col, num)) {
                    mistakes++;
                    document.getElementById('mistakes').innerText = mistakes + '/' + maxMistakes;
                    
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙŠØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£
                    input.style.backgroundColor = '#ffcccc';
                    setTimeout(function() {
                        input.style.backgroundColor = '';
                    }, 500);
                    
                    if (mistakes >= maxMistakes) {
                        gameOver(false);
                    }
                } else {
                    input.style.backgroundColor = '#ccffcc';
                    setTimeout(function() {
                        input.style.backgroundColor = '';
                    }, 300);
                }
            }
        }

        function isValidMove(row, col, num) {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            var board = getBoard();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ
            for (var j = 0; j < 9; j++) {
                if (j !== col && board[row][j] === num) return false;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯
            for (var i = 0; i < 9; i++) {
                if (i !== row && board[i][col] === num) return false;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ 3x3
            var boxRow = Math.floor(row / 3) * 3;
            var boxCol = Math.floor(col / 3) * 3;
            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 3; j++) {
                    var r = boxRow + i;
                    var c = boxCol + j;
                    if (r !== row && c !== col && board[r][c] === num) return false;
                }
            }
            
            return true;
        }

        function getBoard() {
            var board = [];
            for (var i = 0; i < 9; i++) {
                var row = [];
                for (var j = 0; j < 9; j++) {
                    var cell = document.querySelector('input[data-row="' + i + '"][data-col="' + j + '"]');
                    if (cell) {
                        row.push(parseInt(cell.value, 10) || 0);
                    } else {
                        var fixedCell = document.querySelector('tr:nth-child(' + (i+1) + ') td:nth-child(' + (j+1) + ')');
                        row.push(parseInt(fixedCell.textContent, 10) || 0);
                    }
                }
                board.push(row);
            }
            return board;
        }

        function startTimer() {
            var timeLimit = timeLimits[currentDifficulty];
            timerInterval = setInterval(function() {
                seconds++;
                var minutes = Math.floor(seconds / 60);
                var remainingSeconds = seconds % 60;
                document.getElementById('timer').innerText = 
                    (minutes < 10 ? '0' + minutes : minutes) + ':' + 
                    (remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
                if (seconds >= timeLimit) {
                    gameOver(false);
                }
            }, 1000);
        }

        function gameOver(won) {
            if (!gameActive) return;
            
            gameActive = false;
            clearInterval(timerInterval);
            
            if (won) {
                var pointsEarned = levelPoints[currentDifficulty];
                var message = 'ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + currentDifficulty + ' ÙÙŠ ' + formatTime(seconds);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
                fetch('/complete_game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        game_id: gameId,
                        user_id: userId,
                        won: true,
                        points: pointsEarned,
                        difficulty: currentDifficulty,
                        time: seconds
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    document.getElementById('points').innerText = data.new_points;
                    showMessage(message + '\nâœ¨ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ' + pointsEarned + ' Ù†Ù‚Ø·Ø©!', 'success');
                });
            } else {
                var reason = mistakes >= maxMistakes ? 'Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡' : 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯';
                showMessage('ğŸ˜ Ù„Ù„Ø£Ø³ÙØŒ ' + reason + ' Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!', 'error');
            }
        }

        function checkSolution() {
            if (!gameActive) return;
            
            var board = getBoard();
            
            fetch('/check_solution', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    board: board,
                    game_id: gameId,
                    user_id: userId
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    gameOver(true);
                } else {
                    showMessage('âŒ Ø§Ù„Ø­Ù„ ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©!', 'error');
                }
            });
        }

        function formatTime(totalSeconds) {
            var minutes = Math.floor(totalSeconds / 60);
            var seconds = totalSeconds % 60;
            return minutes + ' Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ' + seconds + ' Ø«Ø§Ù†ÙŠØ©';
        }

        function showMessage(text, type) {
            var messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
        }

        function clearBoard() {
            if (!gameActive) return;
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§ØªØŸ')) {
                var inputs = document.querySelectorAll('.cell-input');
                for (var i = 0; i < inputs.length; i++) {
                    inputs[i].value = '';
                }
            }
        }

        function newGame() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… 100 Ù†Ù‚Ø·Ø© Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.')) {
                window.location.href = '/play?user=' + userId + '&difficulty=' + currentDifficulty;
            }
        }

        function changeDifficulty(difficulty) {
            currentDifficulty = difficulty;
            newGame();
        }

        function showHint() {
            if (!gameActive) return;
            
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ ØªÙ„Ù…ÙŠØ­ Ù…Ù‚Ø§Ø¨Ù„ 50 Ù†Ù‚Ø·Ø©ØŸ')) {
                return;
            }
            
            fetch('/get_hint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    game_id: gameId,
                    user_id: userId
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    var cell = document.querySelector('input[data-row="' + data.row + '"][data-col="' + data.col + '"]');
                    if (cell) {
                        cell.value = data.value;
                        cell.style.backgroundColor = '#ffffcc';
                        document.getElementById('points').innerText = data.new_points;
                        showMessage('ğŸ’¡ ØªÙ… ØªÙˆÙÙŠØ± ØªÙ„Ù…ÙŠØ­! ØªÙ… Ø®ØµÙ… 50 Ù†Ù‚Ø·Ø©.', 'info');
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }
    </script>
</body>
</html>
